<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technics SL-PG740A - Final Stable Base</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.cdnfonts.com/css/ds-digital" rel="stylesheet">
    
    <style>
        :root {
            --bg-black: #050505;
            --deck-gray: #1a1a1b;
            --vfd-blue: #40e0ff;
            --vfd-glow: rgba(64, 224, 255, 0.5);
            --vfd-blue-dim: #003a4d;
            --vfd-red: #ff3333;
            --text-silver: #a0a0a0;
            --text-white: #ffffff;
            --ui-font: 'Segoe UI', Tahoma, sans-serif;
            --digital-font: 'DS-Digital', sans-serif;
            --brushed-metal: conic-gradient(from 0deg, #222 0deg, #444 45deg, #222 90deg, #444 135deg, #222 180deg, #444 225deg, #222 270deg, #444 315deg, #222 360deg);
        }

        body {
            background-color: var(--bg-black);
            color: var(--text-silver);
            font-family: var(--ui-font);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; user-select: none;
        }

        .deck-container {
            width: 1200px; background-color: var(--deck-gray);
            padding: 20px 50px 40px 50px; border-top: 1px solid #333;
            border-radius: 4px; box-shadow: 0 80px 150px rgba(0,0,0,1);
        }

        .brand-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #222;
        }

        .main-logo { height: 90px; display: block; opacity: 0.9; }
        .model-name { font-size: 12px; color: var(--text-white); letter-spacing: 3px; font-weight: bold; text-transform: uppercase; }

        .tray-outer-slot {
            width: 100%; height: 75px; background: #000;
            margin-bottom: 35px; position: relative; overflow: hidden; border: 1px solid #111;
        }

        .tray-mechanism {
            position: absolute; width: 100%; height: 100%;
            background: linear-gradient(180deg, #1a1a1b 0%, #151516 100%);
            top: 0; left: 0; z-index: 10;
            transition: transform 1.1s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; justify-content: center; align-items: center;
            border-bottom: 2px solid #000;
        }
        .tray-mechanism.open { transform: translateY(70px); }

        .display-panel {
            background: #000; padding: 25px 35px; border: 4px solid #111;
            box-shadow: inset 0 0 60px rgba(0,0,0,1), 0 0 20px var(--vfd-glow);
            min-height: 240px; display: flex; flex-direction: column;
            justify-content: space-between; box-sizing: border-box;
        }

        .vfd-main-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .vfd-col-track { flex-basis: 140px; }
        .vfd-col-indicators { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            gap: 4px; border-left: 1px solid #111; border-right: 1px solid #111;
            margin: 0 25px; padding: 5px 0;
        }
        .vfd-col-time { flex-basis: 260px; text-align: right; }

        .track-grid {
            display: flex; justify-content: center; align-items: center; gap: 10px;
            margin: 20px 0; padding: 12px 0;
            border-top: 1px solid #0a0a0a; border-bottom: 1px solid #0a0a0a;
        }
        .grid-num {
            font-family: var(--ui-font); font-size: 14px; font-weight: bold;
            color: #0d0d0d; transition: all 0.2s; min-width: 18px; text-align: center;
        }
        .grid-num.loaded { color: #40e0ff; text-shadow: 0 0 8px rgba(64, 224, 255, 0.4); }
        .grid-num.active-track { color: #ff3333 !important; text-shadow: 0 0 12px rgba(255, 51, 51, 0.9); }

        .arrow-indicator {
            font-family: var(--ui-font); font-size: 18px; font-weight: bold;
            color: #0d0d0d; margin-left: 10px; transition: color 0.3s;
        }
        .arrow-indicator.active { color: #ff3333; text-shadow: 0 0 10px rgba(255, 51, 51, 0.8); }

        .vfd-indicator { font-family: var(--ui-font); font-size: 10px; font-weight: bold; color: #08181a; text-transform: uppercase; letter-spacing: 1px; }
        .vfd-indicator.active { color: var(--vfd-blue); text-shadow: 0 0 8px var(--vfd-blue); }
        
        @keyframes blink-vfd-blue { 0%, 100% { color: var(--vfd-blue); text-shadow: 0 0 8px var(--vfd-blue); } 50% { color: #08181a; text-shadow: none; } }
        .vfd-blink-blue { animation: blink-vfd-blue 0.6s step-start infinite !important; }
        
        @keyframes blink-opacity { 50% { opacity: 0.1; } }
        .vfd-blink-dim { animation: blink-opacity 0.6s step-start infinite !important; }

        .digital-counter {
            display: flex; align-items: center; font-family: var(--digital-font); 
            font-size: 60px; font-weight: bold; color: var(--vfd-blue);
            text-shadow: 0 0 15px var(--vfd-blue-dim); line-height: 1;
        }
        .digit { width: 38px; text-align: center; }
        .digit-sign { width: 20px; text-align: center; font-size: 35px; display: none; color: var(--vfd-blue); }
        .digit-sign.visible { display: inline-block; }
        .time-separator { width: 15px; text-align: center; font-size: 40px; padding-bottom: 8px; }

        .label-vfd { font-size: 11px; color: var(--vfd-blue-dim); font-family: var(--ui-font); font-weight: bold; text-transform: uppercase; margin-bottom: 6px; display: block; letter-spacing: 2px;}

        .main-interface { display: grid; grid-template-columns: 120px 1fr 340px; gap: 40px; align-items: start; }
        
        .btn { 
            background: linear-gradient(145deg, #2a2a2b, #151516); border: 1px solid #111; 
            color: var(--text-silver); cursor: pointer; font-size: 11px; font-weight: bold; 
            box-shadow: 3px 3px 6px #000; text-transform: uppercase; height: 50px; width: 100%;
            display: flex; align-items: center; justify-content: center;
        }
        .btn:active { background: linear-gradient(145deg, #151516, #2a2a2b); box-shadow: inset 2px 2px 5px #000; color: var(--text-white); }
        .btn-num { height: 38px; font-size: 15px; }

        .knob { background: var(--brushed-metal); border-radius: 50%; border: 3px solid #111; cursor: pointer; box-shadow: 5px 5px 15px #000; margin: 10px auto; position: relative; }
        .vol-knob { width: 75px; height: 75px; }
        .jog-knob { width: 130px; height: 130px; }

        .vu-meters { opacity: 1; transition: opacity 0.3s ease; }
        .vu-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .vu-label { color: var(--vfd-blue-dim); font-family: var(--ui-font); font-size: 12px; font-weight: bold; width: 15px; }
        .vu-label.active { color: var(--vfd-blue); text-shadow: 0 0 5px var(--vfd-blue); }
        
        .meter-container { flex: 1; height: 10px; background: #080808; display: flex; gap: 2px; padding: 1px; }
        .meter-segment { flex: 1; background: #0a0a0a; transition: background 0.1s; }
        .meter-segment.on-blue { background: var(--vfd-blue); box-shadow: 0 0 5px var(--vfd-blue); }
        .meter-segment.on-red { background: var(--vfd-red); box-shadow: 0 0 5px var(--vfd-red); }

        .controls-right-stack { display: flex; flex-direction: column; gap: 25px; }
    </style>
</head>
<body>

    <div class="deck-container">
        <header class="brand-header">
            <img src="Technics_logo.png" alt="Technics" class="main-logo">
            <div class="model-name">Stereo Compact Disc Player SL-PG740A</div>
        </header>

        <div class="tray-outer-slot">
            <div id="tray-front" class="tray-mechanism">
                <span style="color: #444; font-size: 12px; font-weight: bold; letter-spacing: 5px;">MASH - Multi-Stage Noise Shaping</span>
            </div>
            <div style="position:absolute; width:100%; height:100%; display:flex; justify-content:center; align-items:center;">
                <input type="file" id="file-input" multiple style="display:none">
                <label for="file-input" style="color:#fff; cursor:pointer; font-weight:bold; letter-spacing:3px;">● INSERT COMPACT DISC ●</label>
            </div>
        </div>

        <div class="main-interface">
            <div style="display: flex; flex-direction: column; gap: 40px; align-items: center;">
                <div style="text-align:center; width: 100%;">
                    <span style="font-size:10px; color:white; font-weight:bold; text-transform:uppercase; margin-bottom:10px; display:block;">Power</span>
                    <button class="btn" id="power-reset-btn" style="height:50px; width:70px; margin: 0 auto;">POWER</button>
                </div>
            </div>

            <div class="display-and-controls">
                <section class="display-panel">
                    <div class="vfd-main-row">
                        <div class="vfd-col-track">
                            <span class="label-vfd">Track</span>
                            <div class="digital-counter" id="track-counter-box">
                                <span id="t-d1" class="digit">0</span><span id="t-d2" class="digit">0</span>
                            </div>
                        </div>
                        
                        <div class="vfd-col-indicators">
                            <div id="vfd-shuffle" class="vfd-indicator">Shuffle</div>
                            <div id="vfd-repeat-1" class="vfd-indicator">Repeat 1</div>
                            <div id="vfd-repeat-all" class="vfd-indicator">Repeat All</div>
                            <div id="vfd-ab" class="vfd-indicator">A-B</div>
                        </div>

                        <div class="vfd-col-time" id="time-group">
                            <span id="time-label" class="label-vfd">Min : Sec</span>
                            <div class="digital-counter" id="main-time-display" style="justify-content: flex-end;">
                                <span id="time-sign" class="digit-sign">-</span>
                                <span id="m-d1" class="digit">0</span><span id="m-d2" class="digit">0</span>
                                <span class="time-separator">:</span>
                                <span id="s-d1" class="digit">0</span><span id="s-d2" class="digit">0</span>
                            </div>
                        </div>

                        <div class="vfd-col-time" id="vol-group" style="display: none;">
                            <span class="label-vfd">Volume</span>
                            <div class="digital-counter" style="justify-content: flex-end;">
                                <span id="v-d1" class="digit">0</span><span id="v-d2" class="digit">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="track-grid" id="track-grid-container">
                        <div id="grid-numbers-wrapper" style="display: flex; gap: 10px;"></div>
                        <div id="over-arrow" class="arrow-indicator">▶</div>
                    </div>
                    
                    <div class="vu-meters" id="vu-meters-container">
                        <div class="vu-row"><span class="vu-label" id="lab-L">L</span><div class="meter-container" id="meter-L"></div></div>
                        <div class="vu-row"><span class="vu-label" id="lab-R">R</span><div class="meter-container" id="meter-R"></div></div>
                    </div>
                </section>

                <div style="display:grid; grid-template-columns: repeat(10, 1fr); gap:8px; margin-top:25px;">
                    <button class="btn btn-num" onclick="numJump(1)">1</button>
                    <button class="btn btn-num" onclick="numJump(2)">2</button>
                    <button class="btn btn-num" onclick="numJump(3)">3</button>
                    <button class="btn btn-num" onclick="numJump(4)">4</button>
                    <button class="btn btn-num" onclick="numJump(5)">5</button>
                    <button class="btn btn-num" onclick="numJump(6)">6</button>
                    <button class="btn btn-num" onclick="numJump(7)">7</button>
                    <button class="btn btn-num" onclick="numJump(8)">8</button>
                    <button class="btn btn-num" onclick="numJump(9)">9</button>
                    <button class="btn btn-num" onclick="numJump(0)">0</button>
                </div>

                <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:15px; margin-top:20px;">
                    <button class="btn" id="eject-btn">⏏ EJECT</button>
                    <button class="btn" id="prev-btn">|◀◀</button>
                    <button class="btn" id="play-btn">▶ / ||</button>
                    <button class="btn" id="next-btn">▶▶|</button>
                    <button class="btn" id="stop-btn">■</button>
                </div>
            </div>

            <div class="controls-right-stack">
                <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;">
                    <button class="btn" id="rew-btn">◀◀ Search</button>
                    <button class="btn" id="fwd-btn">Search ▶▶</button>
                    <button class="btn" id="shuffle-btn">Shuffle</button>
                    <button class="btn" id="repeat-btn">Repeat</button>
                    <button class="btn" id="ab-btn">A - B</button>
                    <button class="btn" id="peak-btn">Peak Search</button>
                    <button class="btn" id="time-btn">Time Mode</button>
                    <button class="btn" id="vu-toggle-btn">VU</button>
                </div>
                
                <div style="display: flex; gap: 60px; align-items: center; justify-content: center; margin-top: 10px;">
                    <div style="text-align:center;">
                        <span style="font-size:10px; color:white; font-weight:bold; text-transform:uppercase; margin-bottom:10px; display:block;">Phones Vol</span>
                        <div class="knob vol-knob" id="vol-knob"></div>
                    </div>
                    <div style="text-align:center;">
                        <span style="font-size:10px; color:white; font-weight:bold; text-transform:uppercase; margin-bottom:10px; display:block;">Jog Shuttle</span>
                        <div class="knob jog-knob" id="jog-knob"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const audio = new Audio();
        audio.crossOrigin = "anonymous";
        let audioCtx, analyzer, dataArray, playlist = [], currentIndex = 0;
        
        let currentVol = 2; // Volume à 2% par défaut
        
        let isShuffle = false, repeatMode = 0, timeMode = 0; 
        let volTimer = null, pointA = null, pointB = null, isVUOn = true;
        let inputBuffer = "", inputTimer = null;
        let jogRotation = 0, isPeaking = false;

        const gridWrapper = document.getElementById('grid-numbers-wrapper');
        for(let i=1; i<=20; i++) {
            const span = document.createElement('span');
            span.className = 'grid-num'; span.id = `gn-${i}`; span.innerText = i;
            gridWrapper.appendChild(span);
        }

        function updateTrackGrid() {
            for(let i=1; i<=20; i++) {
                const el = document.getElementById(`gn-${i}`);
                el.classList.remove('loaded', 'active-track');
                if (i <= playlist.length) el.classList.add('loaded');
                if (playlist.length > 0 && i === currentIndex + 1) el.classList.add('active-track');
            }
            document.getElementById('over-arrow').classList.toggle('active', playlist.length > 20);
        }

        function updateDig(prefix, value) {
            const val = Math.floor(Math.abs(value)).toString().padStart(2, '0');
            const d1 = document.getElementById(`${prefix}-d1`);
            const d2 = document.getElementById(`${prefix}-d2`);
            if(d1 && d2) { d1.innerText = val[0]; d2.innerText = val[1]; }
        }

        function showVolumeOverlay() {
            document.getElementById('time-group').style.display = 'none';
            document.getElementById('vol-group').style.display = 'block';
            clearTimeout(volTimer);
            volTimer = setTimeout(() => {
                document.getElementById('time-group').style.display = 'block';
                document.getElementById('vol-group').style.display = 'none';
            }, 2000);
        }

        function applyPrefs() {
            audio.volume = currentVol / 100;
            updateDig('v', currentVol);
            document.getElementById('vol-knob').style.transform = `rotate(${(currentVol / 100 * 300) - 150}deg)`;
            document.getElementById('time-label').innerText = ["Min : Sec", "Remain", "Total Remain"][timeMode];
            document.getElementById('time-sign').classList.toggle('visible', timeMode > 0);
        }

        function numJump(digit) {
            clearTimeout(inputTimer);
            inputBuffer += digit.toString();
            if (inputBuffer.length > 2) inputBuffer = inputBuffer.slice(-2);
            updateDig('t', parseInt(inputBuffer));
            if (inputBuffer.length >= 2) executeJump();
            else inputTimer = setTimeout(executeJump, 800);
        }

        function executeJump() {
            let trackNum = parseInt(inputBuffer);
            inputBuffer = "";
            if (playlist.length >= trackNum && trackNum > 0) {
                loadTrack(trackNum - 1);
            } else {
                updateDig('t', playlist.length > 0 ? currentIndex + 1 : 0);
            }
        }

        audio.onended = () => {
            if (repeatMode === 1) {
                audio.currentTime = 0;
                audio.play();
            } else if (repeatMode === 2) {
                let next = (currentIndex + 1) % playlist.length;
                loadTrack(next);
            } else if (isShuffle) {
                let next; do { next = Math.floor(Math.random() * playlist.length); } while (next === currentIndex);
                loadTrack(next);
            } else if (currentIndex < playlist.length - 1) {
                loadTrack(currentIndex + 1);
            }
        };

        function loadTrack(idx) {
            if (!playlist.length) return;
            currentIndex = Math.max(0, Math.min(idx, playlist.length - 1));
            audio.src = URL.createObjectURL(playlist[currentIndex]);
            updateDig('t', currentIndex + 1);
            updateTrackGrid();
            audio.play().catch(() => {});
            setupAudio();
        }

        document.getElementById('peak-btn').onclick = () => {
            if (!playlist.length || isPeaking) return;
            isPeaking = true; audio.pause();
            let scanProgress = 0; const duration = audio.duration || 180;
            document.getElementById('main-time-display').classList.add('vfd-blink-blue');
            const scanInterval = setInterval(() => {
                scanProgress += (duration / 20);
                updateDig('m', scanProgress / 60); updateDig('s', scanProgress % 60);
                if (scanProgress >= duration) {
                    clearInterval(scanInterval);
                    setTimeout(() => {
                        audio.currentTime = 0; updateDig('m', 0); updateDig('s', 0);
                        document.getElementById('main-time-display').classList.remove('vfd-blink-blue');
                        isPeaking = false;
                    }, 500);
                }
            }, 100);
        };

        document.getElementById('power-reset-btn').onclick = () => {
            audio.pause(); 
            audio.src = ""; 
            playlist = []; 
            currentIndex = 0;
            currentVol = 2; // Réinitialisation à 2%
            inputBuffer = ""; pointA = null; pointB = null; 
            isShuffle = false; repeatMode = 0; timeMode = 0;
            
            // Correction pour permettre le rechargement immédiat des mêmes fichiers
            document.getElementById('file-input').value = "";
            
            document.querySelectorAll('.vfd-indicator').forEach(el => el.classList.remove('active', 'vfd-blink-blue'));
            document.getElementById('main-time-display').classList.remove('vfd-blink-dim');
            applyPrefs(); 
            updateDig('t', 0); updateDig('m', 0); updateDig('s', 0);
            updateTrackGrid(); 
            document.getElementById('tray-front').classList.remove('open');
            showVolumeOverlay();
        };

        document.getElementById('next-btn').onclick = () => {
            if (isShuffle && playlist.length > 1) {
                let next; do { next = Math.floor(Math.random() * playlist.length); } while (next === currentIndex);
                loadTrack(next);
            } else loadTrack(currentIndex + 1);
        };
        
        document.getElementById('shuffle-btn').onclick = () => {
            isShuffle = !isShuffle;
            document.getElementById('vfd-shuffle').classList.toggle('active', isShuffle);
        };

        document.getElementById('repeat-btn').onclick = () => {
            repeatMode = (repeatMode + 1) % 3;
            document.getElementById('vfd-repeat-1').classList.toggle('active', repeatMode === 1);
            document.getElementById('vfd-repeat-all').classList.toggle('active', repeatMode === 2);
        };

        document.getElementById('ab-btn').onclick = () => {
            if (!playlist.length) return;
            const abVfd = document.getElementById('vfd-ab');
            if (pointA === null) { pointA = audio.currentTime; abVfd.classList.add('vfd-blink-blue'); }
            else if (pointB === null) { pointB = audio.currentTime; abVfd.classList.remove('vfd-blink-blue'); abVfd.classList.add('active'); }
            else { pointA = null; pointB = null; abVfd.classList.remove('active', 'vfd-blink-blue'); }
        };

        document.getElementById('vu-toggle-btn').onclick = () => {
            isVUOn = !isVUOn;
            document.querySelectorAll('.vu-label').forEach(l => l.classList.toggle('active', isVUOn));
        };

        document.getElementById('time-btn').onclick = () => { timeMode = (timeMode + 1) % 3; applyPrefs(); };
        audio.onpause = () => { if(!isPeaking) document.getElementById('main-time-display').classList.add('vfd-blink-dim'); };
        audio.onplay = () => document.getElementById('main-time-display').classList.remove('vfd-blink-dim');

        audio.ontimeupdate = () => {
            if (isPeaking) return;
            let t = audio.currentTime;
            if (timeMode === 1) t = Math.max(0, audio.duration - audio.currentTime);
            else if (timeMode === 2) {
                let rem = playlist.length - 1 - currentIndex;
                t = Math.max(0, audio.duration - audio.currentTime) + (rem * 180);
            }
            updateDig('m', t / 60); updateDig('s', t % 60);
            if (pointA !== null && pointB !== null && audio.currentTime >= pointB) audio.currentTime = pointA;
        };

        let isVolActive = false, isJogActive = false;
        const volKnob = document.getElementById('vol-knob'), jogKnob = document.getElementById('jog-knob');
        
        volKnob.onmouseenter = () => showVolumeOverlay();
        volKnob.onmousedown = () => isVolActive = true;
        jogKnob.onmousedown = () => isJogActive = true;
        window.onmouseup = () => { isVolActive = false; isJogActive = false; };
        
        window.onmousemove = (e) => {
            if (isVolActive) { currentVol = Math.max(0, Math.min(100, currentVol - e.movementY * 0.5)); applyPrefs(); showVolumeOverlay(); }
            if (isJogActive && playlist.length) {
                jogRotation += e.movementX;
                jogKnob.style.transform = `rotate(${jogRotation}deg)`;
                audio.currentTime += (e.movementX * 0.2);
            }
        };

        const mL = document.getElementById('meter-L'), mR = document.getElementById('meter-R');
        for(let i=0; i<40; i++) {
            mL.appendChild(document.createElement('div')).className = 'meter-segment';
            mR.appendChild(document.createElement('div')).className = 'meter-segment';
        }

        function setupAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const src = audioCtx.createMediaElementSource(audio);
            analyzer = audioCtx.createAnalyser(); analyzer.fftSize = 64;
            src.connect(analyzer); analyzer.connect(audioCtx.destination);
            dataArray = new Uint8Array(analyzer.frequencyBinCount);
            renderVU();
        }

        function renderVU() {
            requestAnimationFrame(renderVU);
            if (!analyzer) return;
            analyzer.getByteFrequencyData(dataArray);
            [mL, mR].forEach((el, idx) => {
                const segs = el.children;
                const active = isVUOn ? Math.floor((dataArray[idx+2]/255) * 40) : 0;
                for(let i=0; i<40; i++) {
                    segs[i].className = 'meter-segment' + (i < active ? (i > 34 ? ' on-red' : ' on-blue') : '');
                }
            });
        }

        document.getElementById('file-input').onchange = (e) => {
            playlist = Array.from(e.target.files);
            if(playlist.length) loadTrack(0);
            document.getElementById('tray-front').classList.remove('open');
        };

        document.getElementById('eject-btn').onclick = () => document.getElementById('tray-front').classList.toggle('open');
        document.getElementById('play-btn').onclick = () => { if(playlist.length) audio.paused ? audio.play() : audio.pause(); };
        document.getElementById('stop-btn').onclick = () => { audio.pause(); audio.currentTime = 0; };
        document.getElementById('prev-btn').onclick = () => loadTrack(currentIndex - 1);
        document.getElementById('fwd-btn').onclick = () => { audio.currentTime += 5; };
        document.getElementById('rew-btn').onclick = () => { audio.currentTime -= 5; };

        document.getElementById('lab-L').classList.add('active');
        document.getElementById('lab-R').classList.add('active');
        
        applyPrefs(); 
        updateTrackGrid();
    </script>
</body>
</html>
