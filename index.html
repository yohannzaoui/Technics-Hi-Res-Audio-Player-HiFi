<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Technics SL-PS 740</title>
    <link href="https://fonts.cdnfonts.com/css/ds-digital" rel="stylesheet">
    <style>
        :root {
            --bg-color: #080808;
            --panel-color: #141414;
            --vfd-green: #24ff8a;
            --vfd-red: #ff3333;
            --text-color: #b0b0b0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
        }

        .player-container {
            background: var(--panel-color);
            padding: 25px;
            border-radius: 4px;
            width: 90%;
            max-width: 600px;
            border: 1px solid #222;
            box-shadow: 0 40px 100px rgba(0,0,0,0.9);
        }

        .header-line {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
            font-size: 0.75rem;
            color: #888;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .display-panel {
            background: #000;
            padding: 15px;
            border: 2px solid #1a1a1a;
            margin-bottom: 20px;
            text-align: center;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .status-line {
            color: var(--vfd-green);
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 2px;
            height: 1.2rem;
            text-transform: uppercase;
        }

        .time-display {
            color: var(--vfd-green);
            font-family: 'DS-Digital', sans-serif;
            font-size: 5rem;
            font-weight: bold;
            line-height: 1;
            text-shadow: 0 0 15px rgba(36, 255, 138, 0.4);
        }

        .side-indicators {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: left;
            min-width: 140px;
        }

        .ind-row { display: flex; gap: 15px; }

        .ind { 
            font-size: 0.6rem; font-weight: bold; color: #121212; 
            text-transform: uppercase; letter-spacing: 1px; transition: color 0.2s; 
        }
        .ind.active { color: var(--vfd-green); text-shadow: 0 0 8px var(--vfd-green); }

        .track-name-display {
            color: var(--vfd-green);
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            opacity: 0.6;
            text-transform: uppercase;
            overflow: hidden;
            white-space: nowrap;
            margin: 5px 0;
        }

        .track-grid {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            padding: 10px 0;
            border-top: 1px solid #111;
        }

        .track-num {
            font-family: inherit; 
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--vfd-green);
            opacity: 0.3;
        }

        .track-num.active {
            color: var(--vfd-red);
            opacity: 1;
            text-shadow: 0 0 10px var(--vfd-red);
        }

        .vfd-vu-integrated {
            width: 100%;
            height: 60px;
            margin-top: 10px;
        }
        /* Canvas haute r√©solution */
        canvas { width: 100%; height: 100%; display: block; }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px; margin-bottom: 10px;
        }

        button {
            background: #1e1e1e; border: 1px solid #333; color: #ddd;
            padding: 10px 2px; font-size: 0.6rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase;
        }
        button:active { background: #333; }

        .controls-grid-large {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .shuttle-zone { margin-top: 15px; background: #0a0a0a; padding: 15px; }
        .shuttle-label { font-size: 0.6rem; color: #444; text-align: center; margin-bottom: 8px; }
        input[type="range"] { width: 100%; height: 3px; background: #222; outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 30px; height: 15px; background: #444; cursor: pointer;}
    </style>
</head>
<body>

<div class="player-container">
    <div class="header-line">
        <span>Technics</span>
        <span>SL-PS 740 / MASH 1-BIT DAC</span>
    </div>

    <div class="display-panel">
        <div id="status-function" class="status-line">NO DISC</div>
        
        <div style="display:flex; justify-content:center; align-items:center; gap:15px;">
            <div id="timer" class="time-display">00:00</div>
            <div class="side-indicators">
                <div class="ind-row">
                    <div id="ind-shuffle" class="ind">Shuffle On</div>
                    <div id="ind-ab" class="ind">A-B Repeat</div>
                </div>
                <div id="ind-repeat1" class="ind">Repeat 1</div>
                <div id="ind-repeatAll" class="ind">Repeat All</div>
            </div>
        </div>

        <div id="file-name" class="track-name-display">- - - - -</div>
        
        <div id="track-grid" class="track-grid"></div>

        <div class="vfd-vu-integrated" id="vu-container">
            <canvas id="vu-meter" width="800" height="120"></canvas>
        </div>
    </div>

    <div class="controls-grid">
        <button onclick="handlePlay()">Play</button>
        <button onclick="handlePause()">Pause</button>
        <button onclick="prevTrack()">|<<</button>
        <button onclick="nextTrack()">>>|</button>
        <button onclick="handleStop()">Stop</button>
        <button onclick="toggleTime()">Time</button>
    </div>
    
    <div class="controls-grid" style="grid-template-columns: repeat(4, 1fr);">
        <button onclick="runAutoCue()">Auto Cue</button>
        <button onclick="runPeak()">Peak</button>
        <button onclick="skip(-10)">-10s</button>
        <button onclick="skip(10)">+10s</button>
    </div>

    <div class="controls-grid" style="grid-template-columns: repeat(4, 1fr);">
        <button onclick="toggleShuffle()">Shuffle</button>
        <button onclick="toggleRepeat()">Repeat</button>
        <button onclick="handleAB()">A-B</button>
        <button onclick="toggleVUMode()">VU</button>
    </div>

    <div class="controls-grid-large">
        <button onclick="handleOpen()" style="padding: 15px;">Open</button>
        <button onclick="handleClose()" style="padding: 15px;">Close</button>
    </div>

    <div class="shuttle-zone">
        <div class="shuttle-label">JOG SHUTTLE</div>
        <input type="range" id="shuttle" min="-10" max="10" value="0" oninput="doShuttle(this.value)" onchange="resetShuttle()">
    </div>

    <input type="file" id="file-in" style="display:none" accept="audio/*" multiple>
</div>

<audio id="audio" crossorigin="anonymous" playsinline></audio>

<script>
    const audio = document.getElementById('audio');
    const timer = document.getElementById('timer');
    const statusFunc = document.getElementById('status-function');
    const fileNameDisp = document.getElementById('file-name');
    const trackGrid = document.getElementById('track-grid');
    const canvas = document.getElementById('vu-meter');
    const ctx = canvas.getContext('2d');
    const fileIn = document.getElementById('file-in');

    let playlist = [], currentIndex = 0;
    let audioCtx, analyser, dataArray;
    let timeMode = 'elapsed', vuVisible = true;
    let repeatMode = 0, isShuffle = false;
    let pointA = null, pointB = null, lastVolume = 0;

    function handleOpen() { fileIn.click(); }

    function handleClose() {
        handleStop();
        playlist = [];
        currentIndex = 0;
        audio.src = "";
        fileIn.value = "";
        timer.innerText = "00:00";
        statusFunc.innerText = "NO DISC";
        fileNameDisp.innerText = "- - - - -";
        trackGrid.innerHTML = "";
        isShuffle = false;
        repeatMode = 0;
        document.getElementById('ind-shuffle').classList.remove('active');
        document.getElementById('ind-repeat1').classList.remove('active');
        document.getElementById('ind-repeatAll').classList.remove('active');
        document.getElementById('ind-ab').classList.remove('active');
    }

    fileIn.onchange = (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) {
            playlist = files;
            currentIndex = 0;
            updateTrackDisplay();
            loadTrack(0);
            statusFunc.innerText = "READY";
        }
    };

    function updateTrackDisplay() {
        trackGrid.innerHTML = '';
        playlist.forEach((_, i) => {
            const span = document.createElement('span');
            span.className = 'track-num' + (i === currentIndex ? ' active' : '');
            span.innerText = (i + 1);
            trackGrid.appendChild(span);
        });
    }

    function loadTrack(index) {
        if (audio.src) URL.revokeObjectURL(audio.src);
        audio.src = URL.createObjectURL(playlist[index]);
        fileNameDisp.innerText = playlist[index].name.toUpperCase();
        updateTrackDisplay();
        audio.load();
    }

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            const source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            drawVU();
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function handlePlay() { if(playlist.length > 0){ initAudio(); audio.play(); statusFunc.innerText = "PLAY"; } }
    function handlePause() { audio.pause(); statusFunc.innerText = "PAUSE"; }
    function handleStop() { 
        audio.pause(); audio.currentTime = 0; statusFunc.innerText = "STOP"; 
        pointA = pointB = null; 
        document.getElementById('ind-ab').classList.remove('active');
    }

    function nextTrack() {
        if(playlist.length === 0) return;
        let wasPlaying = !audio.paused;
        currentIndex = isShuffle ? Math.floor(Math.random() * playlist.length) : (currentIndex + 1) % playlist.length;
        loadTrack(currentIndex);
        if(wasPlaying) handlePlay();
    }

    function prevTrack() {
        if(playlist.length === 0) return;
        let wasPlaying = !audio.paused;
        currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
        loadTrack(currentIndex);
        if(wasPlaying) handlePlay();
    }

    audio.onended = () => {
        if (repeatMode === 1) { audio.currentTime = 0; audio.play(); } 
        else if (repeatMode === 2) { nextTrack(); handlePlay(); } 
        else {
            if (currentIndex < playlist.length - 1 || isShuffle) { nextTrack(); handlePlay(); } 
            else { handleStop(); }
        }
    };

    function toggleShuffle() {
        isShuffle = !isShuffle;
        document.getElementById('ind-shuffle').classList.toggle('active', isShuffle);
    }

    function toggleRepeat() {
        repeatMode = (repeatMode + 1) % 3;
        document.getElementById('ind-repeat1').classList.toggle('active', repeatMode === 1);
        document.getElementById('ind-repeatAll').classList.toggle('active', repeatMode === 2);
    }

    audio.ontimeupdate = () => {
        if (pointA !== null && pointB !== null && audio.currentTime >= pointB) audio.currentTime = pointA;
        let t = (timeMode === 'remaining' && audio.duration) ? (audio.duration - audio.currentTime) : audio.currentTime;
        const m = Math.floor(t / 60).toString().padStart(2, '0');
        const s = Math.floor(t % 60).toString().padStart(2, '0');
        timer.innerText = `${m}:${s}`;
    };

    function toggleTime() { timeMode = (timeMode === 'elapsed' ? 'remaining' : 'elapsed'); }
    function toggleVUMode() { 
        vuVisible = !vuVisible; 
        document.getElementById('vu-container').style.visibility = vuVisible ? "visible" : "hidden"; 
    }
    function skip(v) { audio.currentTime += v; }

    function handleAB() {
        const ind = document.getElementById('ind-ab');
        if (pointA === null) { pointA = audio.currentTime; ind.classList.add('active'); }
        else if (pointB === null) pointB = audio.currentTime;
        else { pointA = pointB = null; ind.classList.remove('active'); }
    }

    function drawVU() {
        requestAnimationFrame(drawVU);
        if(!analyser || !vuVisible) return;
        analyser.getByteFrequencyData(dataArray);
        let sum = 0; for(let i = 0; i < 15; i++) sum += dataArray[i];
        let currentVol = sum / 15;
        if (currentVol < lastVolume) lastVolume -= 1.5; else lastVolume = currentVol;
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const segments = 22, gap = 8;
        const startX = 60; // Plus d'espace pour les labels
        const segW = ((canvas.width - startX) / segments) - gap;
        const barHeight = 35;
        const spacing = 20;

        ctx.font = "bold 32px sans-serif";
        ctx.textAlign = "left";

        for(let ch = 0; ch < 2; ch++) {
            let y = (ch === 0) ? 10 : 10 + barHeight + spacing;
            
            // Labels L / R en vert VFD
            ctx.fillStyle = "#24ff8a";
            ctx.fillText(ch === 0 ? "L" : "R", 10, y + 28);

            let level = (ch === 0) ? lastVolume : lastVolume * (0.95 + Math.random()*0.1);
            
            for(let i = 0; i < segments; i++) {
                let threshold = (i / segments) * 255;
                if (level > threshold && level > 10) {
                    if (i > 18) ctx.fillStyle = "#ff3333";
                    else if (i > 15) ctx.fillStyle = "#ff9d00";
                    else ctx.fillStyle = "#24ff8a";
                } else { ctx.fillStyle = "#111"; }
                ctx.fillRect(startX + i * (segW + gap), y, segW, barHeight);
            }
        }
    }

    function doShuttle(v) { if(v != 0) { audio.currentTime += (v * 0.4); statusFunc.innerText = v > 0 ? "SEARCH >>" : "<< SEARCH"; } }
    function resetShuttle() { document.getElementById('shuttle').value = 0; if (audio.src) statusFunc.innerText = audio.paused ? "PAUSE" : "PLAY"; }
    function runAutoCue() { audio.currentTime = 0; audio.pause(); statusFunc.innerText = "AUTO CUE"; }
    function runPeak() { statusFunc.innerText = "PEAK"; setTimeout(() => { statusFunc.innerText = "PLAY"; audio.currentTime = audio.duration * 0.3; audio.play(); }, 1000); }
</script>
</body>
</html>
