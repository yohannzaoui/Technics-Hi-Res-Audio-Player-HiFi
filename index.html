<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Technics SL-PS740A</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SL-PS740A">
    
    <link rel="icon" type="image/png" sizes="512x512" href="img/favicon_512.png">
    <link rel="apple-touch-icon" href="img/favicon_512.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#141414">
    <link href="https://fonts.cdnfonts.com/css/ds-digital" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #080808;
            --panel-color: #141414;
            --vfd-green: #24ff8a;
            --vfd-red: #ff3333; /* Rouge VFD pour les alertes et formats */
            --text-color: #b0b0b0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none; user-select: none;
        }

        .player-container {
            background: var(--panel-color);
            padding: 25px; border-radius: 4px;
            width: 90%; max-width: 600px;
            border: 1px solid #222;
            box-shadow: 0 40px 100px rgba(0,0,0,0.9);
        }

        .header-line {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; font-size: 0.75rem; color: #888;
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
        }

        .brand-logo-img { height: 70px; width: auto; display: block; filter: drop-shadow(0px 2px 2px rgba(0, 0, 0, 0.8)); }

        .display-panel {
            background: #000; padding: 15px; border: 2px solid #1a1a1a;
            margin-bottom: 20px; text-align: center; min-height: 280px;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .status-line {
            color: var(--vfd-green); font-size: 0.75rem; font-weight: 600;
            letter-spacing: 2px; height: 1.2rem; text-transform: uppercase;
        }

        .time-display {
            color: var(--vfd-green); font-family: 'DS-Digital', sans-serif;
            font-size: 5rem; font-weight: bold; line-height: 1;
            text-shadow: 0 0 15px rgba(36, 255, 138, 0.4);
            display: flex; justify-content: center; align-items: center;
        }

        .time-display span { width: 1ch; text-align: center; }
        .time-display .separator { width: 0.4ch; margin-bottom: 0.1em; }

        .side-indicators { display: flex; flex-direction: column; gap: 5px; text-align: left; min-width: 140px; }
        .ind-row { display: flex; gap: 15px; }
        .ind { font-size: 0.6rem; font-weight: bold; color: #121212; text-transform: uppercase; }
        .ind.active { color: var(--vfd-green); text-shadow: 0 0 8px var(--vfd-green); }

        /* Style de l'indicateur de format passé en rouge */
        #format-info { 
            font-size: 0.65rem; 
            font-weight: 900; 
            color: var(--vfd-red); 
            text-shadow: 0 0 8px rgba(255, 51, 51, 0.5);
            opacity: 0; 
            letter-spacing: 1px;
        }

        .track-name-display {
            color: var(--vfd-green); font-family: 'Courier New', monospace;
            font-size: 0.7rem; opacity: 0.6; text-transform: uppercase;
            overflow: hidden; white-space: nowrap; margin: 5px 0;
            cursor: pointer;
        }

        .track-grid { display: flex; justify-content: center; flex-wrap: wrap; gap: 12px; padding: 10px 0; border-top: 1px solid #111; }
        .track-num { font-size: 0.85rem; font-weight: 600; color: var(--vfd-green); opacity: 0.3; }
        .track-num.active { color: var(--vfd-red); opacity: 1; text-shadow: 0 0 10px var(--vfd-red); }

        .vfd-vu-integrated { width: 100%; height: 60px; margin-top: 10px; }
        canvas { width: 100%; height: 100%; display: block; }

        .controls-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 10px; }
        .controls-grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        
        button {
            background: #1e1e1e; border: 1px solid #333; color: #ddd;
            padding: 10px 2px; font-size: 0.6rem; font-weight: bold;
            cursor: pointer; text-transform: uppercase; border-radius: 2px;
        }
        button:active { background: #333; }
        .btn-large { padding: 15px !important; }

        .shuttle-zone { margin-top: 15px; background: #0a0a0a; padding: 15px; border-radius: 2px; }
        .shuttle-label { font-size: 0.6rem; color: #ffffff; text-align: center; margin-bottom: 8px; font-weight: bold; }
        input[type="range"] { width: 100%; height: 3px; background: #222; outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { 
            -webkit-appearance: none; width: 40px; height: 16px; background: #444; border: 1px solid #666; cursor: pointer;
        }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.92);
            justify-content: center; align-items: center;
        }
        .modal-content { 
            position: relative; 
            width: 280px; 
            height: 280px;
            background: #000;
            border: 2px solid #333;
            box-shadow: 0 0 30px rgba(0,0,0,1);
        }
        .modal-content img { width: 100%; height: 100%; object-fit: contain; display: block; }
    </style>
</head>
<body>

<div class="player-container">
    <div class="header-line">
        <img src="img/Technics_logo.png" alt="Technics" class="brand-logo-img">
        <span>SL-PS740A / MASH 1-BIT DAC</span>
    </div>

    <div class="display-panel">
        <div id="status-function" class="status-line">NO DISC</div>
        <div style="display:flex; justify-content:center; align-items:center; gap:15px;">
            <div id="timer" class="time-display">
                <span id="m1">0</span><span id="m2">0</span><span class="separator">:</span><span id="s1">0</span><span id="s2">0</span>
            </div>
            <div class="side-indicators">
                <div class="ind-row">
                    <div id="ind-shuffle" class="ind">Shuffle</div> <div id="ind-ab" class="ind">A-B Repeat</div>
                </div>
                <div id="format-info">---</div>
                <div id="ind-repeat1" class="ind">Repeat 1</div>
                <div id="ind-repeatAll" class="ind">Repeat All</div>
            </div>
        </div>
        <div id="file-name" class="track-name-display" onclick="openArtModal()">- - - - -</div>
        <div id="track-grid" class="track-grid"></div>
        <div class="vfd-vu-integrated" id="vu-container">
            <canvas id="vu-meter" width="800" height="120"></canvas>
        </div>
    </div>

    <div class="controls-grid">
        <button onclick="handlePlay()">Play</button>
        <button onclick="handlePause()">Pause</button>
        <button onclick="prevTrack()"><<</button>
        <button onclick="nextTrack()">>></button>
        <button onclick="handleStop()">Stop</button>
        <button onclick="toggleTime()">Time</button>
    </div>
    
    <div class="controls-grid-4">
        <button onclick="runAutoCue()">Auto Cue</button>
        <button onclick="runPeak()">Peak</button>
        <button onclick="skip(-10)">-10s</button>
        <button onclick="skip(10)">+10s</button>
    </div>

    <div class="controls-grid-4">
        <button onclick="toggleShuffle()">Shuffle</button>
        <button onclick="toggleRepeat()">Repeat</button>
        <button onclick="handleAB()">A-B</button>
        <button onclick="toggleVUMode()">VU</button>
    </div>

    <div class="controls-grid-4">
        <button class="btn-large" onclick="handleOpen()">Open</button>
        <button class="btn-large" onclick="changeVolume(-0.1)" onmouseover="showVolume()" onmouseout="hideVolume()">VOL -</button>
        <button class="btn-large" onclick="changeVolume(0.1)" onmouseover="showVolume()" onmouseout="hideVolume()">VOL +</button>
        <button class="btn-large" onclick="handleClose()">Close</button>
    </div>

    <div class="shuttle-zone">
        <div class="shuttle-label">JOG SHUTTLE</div>
        <input type="range" id="shuttle" min="-10" max="10" value="0" oninput="doShuttle(this.value)" onchange="resetShuttle()">
    </div>

    <input type="file" id="file-in" style="display:none" accept="audio/*" multiple>
</div>

<div id="artModal" class="modal" onclick="closeArtModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <img id="modalImg" src="img/Technics_logo.png">
    </div>
</div>

<audio id="audio" crossorigin="anonymous" playsinline></audio>

<script>
    const audio = document.getElementById('audio');
    const statusFunc = document.getElementById('status-function');
    const fileNameDisp = document.getElementById('file-name');
    const formatInfo = document.getElementById('format-info');
    const trackGrid = document.getElementById('track-grid');
    const canvas = document.getElementById('vu-meter');
    const ctx = canvas.getContext('2d');
    const fileIn = document.getElementById('file-in');
    const modal = document.getElementById('artModal');
    const modalImg = document.getElementById('modalImg');

    const m1 = document.getElementById('m1'), m2 = document.getElementById('m2'), s1 = document.getElementById('s1'), s2 = document.getElementById('s2');

    let playlist = [], currentIndex = 0, currentArtURL = "";
    let audioCtx, analyser, dataArray, timeMode = 'elapsed', vuVisible = true, repeatMode = 0, isShuffle = false;
    let pointA = null, pointB = null, lastVolume = 0, previousStatus = "READY";

    window.onload = () => { audio.volume = 0.2; };

    function changeVolume(delta) { audio.volume = Math.min(1, Math.max(0, audio.volume + delta)); showVolume(); }
    function showVolume() { if (!statusFunc.innerText.includes("VOLUME")) previousStatus = statusFunc.innerText; statusFunc.innerText = `VOLUME: ${Math.round(audio.volume * 10)}`; }
    function hideVolume() { statusFunc.innerText = previousStatus; }

    function handleOpen() { fileIn.click(); }
    fileIn.onchange = (e) => {
        const files = Array.from(e.target.files);
        if (files.length > 0) { playlist = files; currentIndex = 0; updateTrackDisplay(); loadTrack(0); statusFunc.innerText = "READY"; }
    };

    function loadTrack(index) {
        const file = playlist[index];
        if (audio.src) URL.revokeObjectURL(audio.src);
        audio.src = URL.createObjectURL(file);
        
        // Mise à jour du format en rouge
        formatInfo.innerText = file.name.split('.').pop().toUpperCase();
        formatInfo.style.opacity = "1";
        
        if (window.jsmediatags) {
            window.jsmediatags.read(file, {
                onSuccess: function(tag) {
                    const t = tag.tags;
                    fileNameDisp.innerText = `${t.artist || "UNKNOWN"} - ${t.album || "UNKNOWN"} - ${t.title || file.name}`.toUpperCase();
                    if (currentArtURL) URL.revokeObjectURL(currentArtURL);
                    if (t.picture) {
                        const { data, format } = t.picture;
                        currentArtURL = URL.createObjectURL(new Blob([new Uint8Array(data)], { type: format }));
                        modalImg.src = currentArtURL;
                    } else { modalImg.src = "img/Technics_logo.png"; }
                    updateMediaSession(t.title || file.name, t.artist || "TECHNICS", t.album || "CD PLAYER");
                },
                onError: function() { fileNameDisp.innerText = file.name.toUpperCase(); modalImg.src = "img/Technics_logo.png"; }
            });
        }
        updateTrackDisplay(); audio.load();
    }

    function openArtModal() { if(playlist.length > 0) modal.style.display = "flex"; }
    function closeArtModal() { modal.style.display = "none"; }

    function updateMediaSession(t, a, al) {
        if ('mediaSession' in navigator) {
            navigator.mediaSession.metadata = new MediaMetadata({ title: t, artist: a, album: al, artwork: [{ src: 'img/favicon_512.png', sizes: '512x512', type: 'image/png' }] });
            navigator.mediaSession.setActionHandler('play', handlePlay);
            navigator.mediaSession.setActionHandler('pause', handlePause);
            navigator.mediaSession.setActionHandler('previoustrack', prevTrack);
            navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
        }
    }

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser(); analyser.fftSize = 256;
            const source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser); analyser.connect(audioCtx.destination);
            dataArray = new Uint8Array(analyser.frequencyBinCount); drawVU();
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function handlePlay() { if(playlist.length > 0){ initAudio(); audio.play(); statusFunc.innerText = "PLAY"; } }
    function handlePause() { audio.pause(); statusFunc.innerText = "PAUSE"; }
    function handleStop() { audio.pause(); audio.currentTime = 0; statusFunc.innerText = "STOP"; pointA = pointB = null; document.getElementById('ind-ab').classList.remove('active'); }

    function nextTrack() {
        if(playlist.length === 0) return;
        if(repeatMode === 1) { audio.currentTime = 0; handlePlay(); return; }
        currentIndex = isShuffle ? Math.floor(Math.random() * playlist.length) : (currentIndex + 1) % playlist.length;
        loadTrack(currentIndex); handlePlay();
    }

    function prevTrack() {
        if(playlist.length === 0) return;
        if(repeatMode === 1 || audio.currentTime > 3) { audio.currentTime = 0; handlePlay(); return; }
        currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
        loadTrack(currentIndex); handlePlay();
    }

    function toggleShuffle() { isShuffle = !isShuffle; document.getElementById('ind-shuffle').classList.toggle('active', isShuffle); }
    function toggleRepeat() {
        repeatMode = (repeatMode + 1) % 3;
        document.getElementById('ind-repeat1').classList.toggle('active', repeatMode === 1);
        document.getElementById('ind-repeatAll').classList.toggle('active', repeatMode === 2);
    }

    audio.onended = () => { if(repeatMode === 1) { audio.currentTime = 0; audio.play(); } else if(repeatMode === 2 || currentIndex < playlist.length - 1) { nextTrack(); } else { handleStop(); } };
    audio.ontimeupdate = () => {
        if (pointA !== null && pointB !== null && audio.currentTime >= pointB) audio.currentTime = pointA;
        let t = (timeMode === 'remaining' && audio.duration) ? (audio.duration - audio.currentTime) : audio.currentTime;
        if(isNaN(t)) t = 0;
        const mm = Math.floor(t / 60).toString().padStart(2, '0');
        const ss = Math.floor(t % 60).toString().padStart(2, '0');
        m1.innerText = mm[0]; m2.innerText = mm[1]; s1.innerText = ss[0]; s2.innerText = ss[1];
    };

    function drawVU() {
        requestAnimationFrame(drawVU);
        if(!analyser || !vuVisible) return;
        analyser.getByteFrequencyData(dataArray);
        let sum = 0; for(let i = 0; i < 15; i++) sum += dataArray[i];
        let currentVol = sum / 15;
        if (currentVol < lastVolume) lastVolume -= 1.5; else lastVolume = currentVol;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const segments = 22, gap = 8, startX = 60, segW = ((canvas.width - startX) / segments) - gap;
        for(let ch = 0; ch < 2; ch++) {
            let y = (ch === 0) ? 10 : 65; ctx.fillStyle = "#24ff8a"; ctx.font = "bold 32px sans-serif";
            ctx.fillText(ch === 0 ? "L" : "R", 10, y + 28);
            let level = (ch === 0) ? lastVolume : lastVolume * (0.95 + Math.random()*0.1);
            for(let i = 0; i < segments; i++) {
                let threshold = (i / segments) * 255;
                if (level > threshold && level > 10) { ctx.fillStyle = (i > 18) ? "#ff3333" : (i > 15 ? "#ff9d00" : "#24ff8a"); }
                else { ctx.fillStyle = "#111"; }
                ctx.fillRect(startX + i * (segW + gap), y, segW, 35);
            }
        }
    }

    function toggleTime() { timeMode = (timeMode === 'elapsed' ? 'remaining' : 'elapsed'); }
    function toggleVUMode() { vuVisible = !vuVisible; document.getElementById('vu-container').style.visibility = vuVisible ? "visible" : "hidden"; }
    function skip(v) { audio.currentTime += v; }
    function handleAB() {
        const ind = document.getElementById('ind-ab');
        if (pointA === null) { pointA = audio.currentTime; ind.classList.add('active'); }
        else if (pointB === null) pointB = audio.currentTime;
        else { pointA = pointB = null; ind.classList.remove('active'); }
    }
    function doShuttle(v) { if(v != 0) { audio.currentTime += (v * 0.4); statusFunc.innerText = v > 0 ? "SEARCH >>" : "<< SEARCH"; } }
    function resetShuttle() { document.getElementById('shuttle').value = 0; if (audio.src) statusFunc.innerText = audio.paused ? "PAUSE" : "PLAY"; }
    function updateTrackDisplay() {
        trackGrid.innerHTML = '';
        playlist.forEach((_, i) => {
            const span = document.createElement('span');
            span.className = 'track-num' + (i === currentIndex ? ' active' : '');
            span.innerText = (i + 1);
            trackGrid.appendChild(span);
        });
    }
    function handleClose() {
        handleStop(); playlist = []; currentIndex = 0; audio.src = ""; fileIn.value = "";
        m1.innerText = "0"; m2.innerText = "0"; s1.innerText = "0"; s2.innerText = "0";
        statusFunc.innerText = "NO DISC"; fileNameDisp.innerText = "- - - - -";
        formatInfo.style.opacity = "0"; trackGrid.innerHTML = "";
        isShuffle = false; repeatMode = 0; modalImg.src = "img/Technics_logo.png";
        document.querySelectorAll('.ind').forEach(el => el.classList.remove('active'));
    }
    function runAutoCue() {
        if (playlist.length === 0) return;
        statusFunc.innerText = "AUTO CUE"; audio.pause(); audio.currentTime = 0;
        setTimeout(() => { audio.currentTime = 0.1; statusFunc.innerText = "A.CUE READY"; }, 800);
    }
    function runPeak() {
        if (playlist.length === 0) return;
        statusFunc.innerText = "PEAK SEARCH";
        let peakTime = audio.duration * 0.75;
        setTimeout(() => {
            audio.currentTime = peakTime; audio.play(); statusFunc.innerText = "PEAK FOUND";
            setTimeout(() => { audio.pause(); audio.currentTime = 0; statusFunc.innerText = "READY"; }, 3000);
        }, 1500);
    }
</script>
</body>
</html>