<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Marantz SACD 30n - Real Metadata (ID3)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <style>
        :root {
            --bg-main: #020202;
            --panel-color: #121212;
            --side-texture-dark: #050505; 
            --side-texture-light: #1c1c1c;
            --display-bg: #000000;
            --text-main: #ffffff;
            --accent-glow: rgba(0, 160, 255, 0.15);
            --btn-bg: linear-gradient(145deg, #252525, #0a0a0a);
            --border-color: #252525;
            --oled-text: #00d4ff;
            --btn-text: #ffffff;
        }

        [data-theme="light"] {
            --bg-main: #b0b0b0;
            --panel-color: #dcdcdc;
            --side-texture-dark: #c5c5c5;
            --side-texture-light: #e8e8e8;
            --display-bg: #080808;
            --text-main: #111111;
            --accent-glow: rgba(255, 255, 255, 0.4);
            --btn-bg: linear-gradient(145deg, #f9f9f9, #c5c5c5);
            --border-color: #a0a0a0;
            --oled-text: #ffffff;
            --btn-text: #333333;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .player-container {
            position: relative;
            width: 1400px; 
            height: 750px; 
            background: var(--panel-color);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 50px 100px rgba(0,0,0,0.8);
        }

        .side-panel {
            position: absolute;
            top: 0; width: 250px; height: 100%; cursor: pointer;
            background: repeating-linear-gradient(45deg, var(--side-texture-dark), var(--side-texture-dark) 4px, var(--side-texture-light) 4px, var(--side-texture-light) 8px);
            z-index: 1;
        }
        .left-panel { left: 0; border-right: 1px solid var(--border-color); }
        .right-panel { right: 0; border-left: 1px solid var(--border-color); }

        .logo-box { z-index: 10; margin-top: 40px; cursor: pointer; }
        .logo-img { width: 220px; filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.5)); }

        .display-unit {
            position: relative;
            z-index: 5;
            margin-top: 25px;
            width: 850px; 
            height: 300px; 
            background: var(--display-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 60px rgba(0,0,0,1), 0 0 20px var(--accent-glow);
            border: 2px solid #1a1a1a;
            overflow: hidden;
        }

        .time-counter {
            font-family: 'Courier New', monospace;
            color: var(--oled-text);
            font-size: 1.4rem;
            margin-bottom: 10px;
        }

        .track-info { 
            color: var(--oled-text); 
            font-family: 'Courier New', monospace; 
            font-size: 0.95rem; 
            text-transform: uppercase;
            text-align: center;
            width: 90%;
            letter-spacing: 1px;
            line-height: 1.6;
        }

        .codec-badge { margin-top: 15px; font-size: 0.9rem; color: #666; letter-spacing: 2px; height: 1.2rem; }
        .track-counter { margin-top: 8px; font-size: 0.85rem; color: var(--oled-text); font-family: 'Courier New', monospace; opacity: 0.6; }

        .control-section { z-index: 20; display: flex; flex-direction: column; gap: 15px; margin-top: 40px; }
        .transport-bar { display: flex; gap: 15px; justify-content: center; }

        .btn-transport {
            background: var(--btn-bg);
            border: 1px solid var(--border-color);
            color: var(--btn-text);
            width: 85px; height: 60px; cursor: pointer;
            font-size: 1.2rem; display: flex; justify-content: center; align-items: center;
            border-radius: 4px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        .btn-transport:hover { border-color: #00d4ff; color: #00d4ff; }
        .play-btn { width: 130px; font-size: 1.6rem; }
        .btn-active { color: #00d4ff !important; border-color: #00d4ff !important; }

        #fileInput { display: none; }

        .mode-indicators {
            position: absolute;
            top: 20px; right: 30px; display: flex; gap: 10px;
            font-family: 'Courier New', monospace; font-size: 0.8rem; color: var(--oled-text);
        }
        .indicator { display: none; border: 1px solid var(--oled-text); padding: 2px 5px; border-radius: 2px; }
    </style>
</head>
<body data-theme="dark">

    <input type="file" id="fileInput" multiple accept=".mp3,.flac,.wav,.m4a,.aac">

    <div class="player-container">
        <div class="side-panel left-panel" onclick="toggleTheme()"></div>
        <div class="side-panel right-panel" onclick="toggleTheme()"></div>
        
        <div class="logo-box" onclick="toggleTheme()">
            <img src="marantz.png" alt="Marantz" class="logo-img">
        </div>

        <div class="display-unit">
            <div class="mode-indicators">
                <span id="indShuffle" class="indicator">SHF</span>
                <span id="indRepeat" class="indicator">RPT</span>
            </div>
            <div class="time-counter" id="timer">00:00 / 00:00</div>
            <div class="track-info" id="status">READY</div>
            <div class="codec-badge" id="codecInfo">BIT-PERFECT DAC</div>
            <div class="track-counter" id="trackCount">TRACK: 0 / 0</div>
        </div>

        <div class="control-section">
            <div class="transport-bar">
                <button class="btn-transport" onclick="handleEject()">⏏</button>
                <button class="btn-transport" onclick="prevTrack()">⏮</button>
                <button class="btn-transport play-btn" onclick="togglePlay()">▶ / ⏸</button>
                <button class="btn-transport" onclick="nextTrack()">⏭</button>
                <button class="btn-transport" onclick="resetApp()">■</button>
            </div>

            <div class="transport-bar">
                <button class="btn-transport" id="shuffleBtn" onclick="toggleShuffle()" style="font-size: 0.7rem;">SHUFFLE</button>
                <button class="btn-transport" onmouseover="showVolume()" onmouseout="hideVolume()" onclick="changeVolume(-0.05)" style="font-size: 0.8rem;">VOL -</button>
                <button class="btn-transport" onmouseover="showVolume()" onmouseout="hideVolume()" onclick="changeVolume(0.05)" style="font-size: 0.8rem;">VOL +</button>
                <button class="btn-transport" id="repeatBtn" onclick="toggleRepeat()" style="font-size: 0.7rem;">REPEAT</button>
            </div>
        </div>
    </div>

    <script>
        const audio = new Audio();
        const jsmediatags = window.jsmediatags;
        let playlist = [];
        let currentIndex = 0;
        let isShuffle = false;
        let volTimeout;
        let currentBlobUrl = null;
        
        const fileInput = document.getElementById('fileInput');
        const statusEl = document.getElementById('status');
        const codecEl = document.getElementById('codecInfo');
        const timerEl = document.getElementById('timer');
        const trackCountEl = document.getElementById('trackCount');
        const indShuffle = document.getElementById('indShuffle');
        const indRepeat = document.getElementById('indRepeat');

        let settings = JSON.parse(localStorage.getItem('marantz_prefs')) || { theme: 'dark', volume: 0.05 };
        document.body.setAttribute('data-theme', settings.theme);
        audio.volume = settings.volume;

        function handleEject() {
            if (playlist.length > 0) resetApp();
            else fileInput.click();
        }

        fileInput.onchange = (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                playlist = files;
                currentIndex = 0;
                statusEl.innerText = "FILES LOADED";
                updateTrackCounter();
            }
        };

        function loadTrack(index) {
            if (!playlist[index]) return;
            const file = playlist[index];

            // 1. Lire les métadonnées réelles
            jsmediatags.read(file, {
                onSuccess: function(tag) {
                    const artist = tag.tags.artist || "Unknown Artist";
                    const album = tag.tags.album || "Unknown Album";
                    const title = tag.tags.title || file.name.replace(/\.[^/.]+$/, "");
                    statusEl.innerText = `${artist} / ${album} / ${title}`.toUpperCase();
                },
                onError: function(error) {
                    // Fallback sur le nom du fichier si pas de tags
                    statusEl.innerText = file.name.replace(/\.[^/.]+$/, "").toUpperCase();
                }
            });

            // 2. Gestion de l'audio
            if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
            currentBlobUrl = URL.createObjectURL(file);
            audio.src = currentBlobUrl;
            
            displayCodec(file);
            updateTrackCounter();
        }

        function displayCodec(file) {
            codecEl.innerText = file.name.split('.').pop().toUpperCase() + " | HI-RES";
        }

        function updateTrackCounter() {
            trackCountEl.innerText = playlist.length > 0 ? `TRACK: ${currentIndex + 1} / ${playlist.length}` : "TRACK: 0 / 0";
        }

        function showVolume() {
            clearTimeout(volTimeout);
            codecEl.innerText = `VOLUME: ${Math.round(audio.volume * 100)}`;
            codecEl.style.color = "var(--oled-text)";
        }

        function hideVolume() {
            volTimeout = setTimeout(() => {
                codecEl.style.color = "#666";
                if (playlist[currentIndex]) displayCodec(playlist[currentIndex]);
                else codecEl.innerText = playlist.length > 0 ? "FILES READY" : "BIT-PERFECT DAC";
            }, 800);
        }

        function changeVolume(delta) {
            let v = Math.round((audio.volume + delta) * 20) / 20;
            audio.volume = Math.max(0, Math.min(1, v));
            settings.volume = audio.volume;
            save();
            showVolume();
        }

        function togglePlay() {
            if (playlist.length === 0) return;
            if (audio.paused) {
                if (!audio.src || audio.src === window.location.href) loadTrack(currentIndex);
                audio.play();
                statusEl.style.color = "var(--oled-text)";
            } else {
                audio.pause();
                statusEl.style.color = "#666";
            }
        }

        function nextTrack() {
            if (playlist.length === 0) return;
            if (isShuffle) {
                currentIndex = Math.floor(Math.random() * playlist.length);
            } else {
                currentIndex = (currentIndex + 1) % playlist.length;
            }
            loadTrack(currentIndex);
            audio.play();
        }

        function prevTrack() {
            if (playlist.length === 0) return;
            currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
            loadTrack(currentIndex);
            audio.play();
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            document.getElementById('shuffleBtn').classList.toggle('btn-active', isShuffle);
            indShuffle.style.display = isShuffle ? "block" : "none";
        }

        function toggleRepeat() {
            audio.loop = !audio.loop;
            document.getElementById('repeatBtn').classList.toggle('btn-active', audio.loop);
            indRepeat.style.display = audio.loop ? "block" : "none";
        }

        audio.ontimeupdate = () => {
            const format = (s) => isNaN(s) ? "00:00" : new Date(s * 1000).toISOString().substr(14, 5);
            timerEl.innerText = `${format(audio.currentTime)} / ${format(audio.duration)}`;
        };

        function resetApp() {
            audio.pause();
            if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
            audio.removeAttribute('src');
            audio.load();
            playlist = [];
            currentIndex = 0;
            fileInput.value = "";
            statusEl.innerText = "READY";
            timerEl.innerText = "00:00 / 00:00";
            codecEl.innerText = "BIT-PERFECT DAC";
            updateTrackCounter();
            indShuffle.style.display = "none";
            indRepeat.style.display = "none";
            document.getElementById('shuffleBtn').classList.remove('btn-active');
            document.getElementById('repeatBtn').classList.remove('btn-active');
            isShuffle = false;
            audio.loop = false;
        }

        function toggleTheme() {
            settings.theme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', settings.theme);
            save();
        }

        function save() { localStorage.setItem('marantz_prefs', JSON.stringify(settings)); }
        audio.onended = () => { if(!audio.loop) nextTrack(); };
    </script>
</body>
</html>
