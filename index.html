<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technics SL-PG740A - Professional Interface</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.cdnfonts.com/css/ds-digital" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    
    <style>
        :root {
            --bg-black: #050505;
            --deck-gray: #1a1a1b;
            --vfd-blue: #40e0ff;
            --vfd-glow: rgba(64, 224, 255, 0.5);
            --vfd-blue-dim: #003a4d;
            --vfd-off: #0a0a0a;
            --vfd-red: #ff3333;
            --text-silver: #a0a0a0;
            --text-white: #ffffff;
            --ui-font: 'Segoe UI', Tahoma, sans-serif;
            --digital-font: 'DS-Digital', sans-serif;
            --brushed-metal: conic-gradient(from 0deg, #222 0deg, #444 45deg, #222 90deg, #444 135deg, #222 180deg, #444 225deg, #222 270deg, #444 315deg, #222 360deg);
        }

        body {
            background-color: var(--bg-black);
            color: var(--text-silver);
            font-family: var(--ui-font);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; user-select: none;
            overflow: hidden;
        }

        .deck-container {
            width: 1200px; background-color: var(--deck-gray);
            padding: 20px 50px 40px 50px; border-top: 1px solid #333;
            border-radius: 4px; box-shadow: 0 80px 150px rgba(0,0,0,1);
        }

        .brand-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #222;
        }

        .main-logo { height: 90px; display: block; opacity: 0.9; }
        .model-name { font-size: 12px; color: var(--text-white); letter-spacing: 3px; font-weight: bold; text-transform: uppercase; }

        .tray-outer-slot {
            width: 100%; height: 75px; background: #000;
            margin-bottom: 35px; position: relative; overflow: hidden; border: 1px solid #111;
        }

        .tray-mechanism {
            position: absolute; width: 100%; height: 100%;
            background: linear-gradient(180deg, #1a1a1b 0%, #151516 100%);
            top: 0; left: 0; z-index: 10;
            transition: transform 1.1s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; justify-content: center; align-items: center;
            border-bottom: 2px solid #000;
        }
        .tray-mechanism.open { transform: translateY(70px); }

        .display-panel {
            background: #000; padding: 25px 35px; border: 4px solid #111;
            box-shadow: inset 0 0 60px rgba(0,0,0,1), 0 0 20px var(--vfd-glow);
            min-height: 240px; display: flex; flex-direction: column;
            justify-content: space-between; box-sizing: border-box;
        }

        .vfd-main-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; }
        .vfd-col-track { flex-basis: 140px; }
        .vfd-col-indicators { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            gap: 4px; border-left: 1px solid #111; border-right: 1px solid #111;
            margin: 0 25px; padding: 5px 0;
        }
        .vfd-col-time { flex-basis: 260px; text-align: right; }

        .track-grid {
            display: flex; justify-content: center; align-items: center; gap: 10px;
            margin: 20px 0; padding: 12px 0;
            border-top: 1px solid #0a0a0a; border-bottom: 1px solid #0a0a0a;
        }
        .grid-num {
            font-family: var(--ui-font); font-size: 14px; font-weight: bold;
            color: #0d0d0d; transition: all 0.2s; min-width: 18px; text-align: center;
        }
        .grid-num.loaded { color: #40e0ff; text-shadow: 0 0 8px rgba(64, 224, 255, 0.4); }
        .grid-num.active-track { color: #ff3333 !important; text-shadow: 0 0 12px rgba(255, 51, 51, 0.9); }

        .arrow-indicator {
            font-family: var(--ui-font); font-size: 18px; font-weight: bold;
            color: #0d0d0d; margin-left: 10px; transition: color 0.3s;
        }
        .arrow-indicator.active { color: #ff3333; text-shadow: 0 0 10px rgba(255, 51, 51, 0.8); }

        .vfd-indicator { font-family: var(--ui-font); font-size: 10px; font-weight: bold; color: #08181a; text-transform: uppercase; letter-spacing: 1px; }
        .vfd-indicator.active { color: var(--vfd-blue); text-shadow: 0 0 8px var(--vfd-blue); }
        
        @keyframes vfd-flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
        .vfd-input-blink { animation: vfd-flash 0.4s infinite; }
        .vfd-blink-dim { animation: vfd-flash 0.8s infinite; }

        .digital-counter {
            display: flex; align-items: center; font-family: var(--digital-font); 
            font-size: 60px; font-weight: bold; color: var(--vfd-blue);
            text-shadow: 0 0 15px var(--vfd-blue-dim); line-height: 1;
        }
        .digit { width: 38px; text-align: center; }
        .time-separator { width: 15px; text-align: center; font-size: 40px; padding-bottom: 8px; transition: opacity 0.2s; }

        .label-vfd { font-size: 11px; color: var(--vfd-blue-dim); font-family: var(--ui-font); font-weight: bold; text-transform: uppercase; margin-bottom: 6px; display: block; letter-spacing: 2px;}
        .label-vfd.clickable { cursor: pointer; color: var(--vfd-blue); transition: color 0.2s; }

        .main-interface { display: grid; grid-template-columns: 120px 1fr 340px; gap: 40px; align-items: start; }
        
        .btn { 
            background: linear-gradient(145deg, #2a2a2b, #151516); border: 1px solid #111; 
            color: var(--text-silver); cursor: pointer; font-size: 11px; font-weight: bold; 
            box-shadow: 3px 3px 6px #000; text-transform: uppercase; height: 50px; width: 100%;
            display: flex; align-items: center; justify-content: center;
        }
        .btn:active { background: linear-gradient(145deg, #151516, #2a2a2b); box-shadow: inset 2px 2px 5px #000; color: var(--text-white); }

        .numeric-grid {
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; 
            margin-top: 25px; width: 100%;
        }

        .transport-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; 
            margin-top: 20px; width: 100%;
        }

        .knob-container { text-align: center; }
        .knob { 
            background: var(--brushed-metal); border-radius: 50%; border: 3px solid #111; 
            cursor: pointer; box-shadow: 5px 5px 15px #000; margin: 10px auto; 
            position: relative; transform: rotate(-110deg); transition: transform 0.1s linear;
        }
        .vol-knob { width: 75px; height: 75px; }
        .jog-knob { width: 130px; height: 130px; transform: rotate(0deg); }

        .vu-meters { transition: opacity 0.3s ease; }
        .vu-row { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .vu-label { color: #08181a; font-family: var(--ui-font); font-size: 12px; font-weight: bold; width: 15px; transition: color 0.3s; }
        .vu-label.on { color: var(--vfd-blue); text-shadow: 0 0 5px var(--vfd-blue); }
        
        .meter-container { flex: 1; height: 10px; background: #080808; display: flex; gap: 2px; padding: 1px; }
        .meter-segment { flex: 1; background: var(--vfd-off); transition: background 0.05s; }
        .meter-segment.on-blue { background: var(--vfd-blue); box-shadow: 0 0 5px var(--vfd-blue); }
        .meter-segment.on-red { background: var(--vfd-red); box-shadow: 0 0 5px var(--vfd-red); }

        #art-modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.85);
            justify-content: center; align-items: center; backdrop-filter: blur(8px);
        }
        .modal-content {
            background: #111; border: 2px solid #333; padding: 25px;
            box-shadow: 0 0 80px rgba(0,0,0,1); text-align: center; border-radius: 8px;
            max-width: 500px;
        }
        #art-image { width: 400px; height: 400px; object-fit: cover; border-radius: 4px; box-shadow: 0 0 20px #000; }
        #art-info { color: var(--vfd-blue); margin-top: 20px; font-weight: bold; text-transform: uppercase; font-size: 14px; letter-spacing: 1px; line-height: 1.5; }
    </style>
</head>
<body>

    <div id="art-modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <img id="art-image" src="technics_logo.png">
            <div id="art-info">Technics - Audio Systems - Professional</div>
        </div>
    </div>

    <div class="deck-container">
        <header class="brand-header">
            <img src="Technics_logo.png" class="main-logo">
            <div class="model-name">Stereo Compact Disc Player SL-PG740A</div>
        </header>

        <div class="tray-outer-slot">
            <div id="tray-front" class="tray-mechanism">
                <span style="color: #444; font-size: 12px; font-weight: bold; letter-spacing: 5px;">MASH - Multi-Stage Noise Shaping</span>
            </div>
            <div style="position:absolute; width:100%; height:100%; display:flex; justify-content:center; align-items:center;">
                <input type="file" id="file-input" multiple style="display:none">
                <label for="file-input" style="color:#fff; cursor:pointer; font-weight:bold; letter-spacing:3px;">● INSERT COMPACT DISC ●</label>
            </div>
        </div>

        <div class="main-interface">
            <div style="text-align:center;">
                <button class="btn" id="power-reset-btn" style="height:50px; width:70px;">POWER</button>
            </div>

            <div class="display-and-controls">
                <section class="display-panel">
                    <div class="vfd-main-row">
                        <div class="vfd-col-track" id="track-vfd-box">
                            <span class="label-vfd clickable" id="track-label" onclick="openArt()">Track</span>
                            <div class="digital-counter"><span id="t-d1" class="digit">0</span><span id="t-d2" class="digit">0</span></div>
                        </div>
                        <div class="vfd-col-indicators">
                            <div id="vfd-shuffle" class="vfd-indicator">Shuffle</div>
                            <div id="vfd-repeat-1" class="vfd-indicator">Repeat 1</div>
                            <div id="vfd-repeat-all" class="vfd-indicator">Repeat All</div>
                            <div id="vfd-ab" class="vfd-indicator">A-B</div>
                        </div>
                        <div class="vfd-col-time">
                            <span class="label-vfd" id="time-label">Min : Sec</span>
                            <div class="digital-counter" id="main-time-display" style="justify-content: flex-end;">
                                <span id="m-d1" class="digit">0</span><span id="m-d2" class="digit">0</span>
                                <span class="time-separator" id="time-sep">:</span>
                                <span id="s-d1" class="digit">0</span><span id="s-d2" class="digit">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="track-grid">
                        <div id="grid-numbers-wrapper" style="display: flex; gap: 10px; align-items: center;"></div>
                        <div id="over-arrow" class="arrow-indicator">▶</div>
                    </div>
                    <div class="vu-meters" id="vu-meters-container">
                        <div class="vu-row"><span class="vu-label on" id="lbl-L">L</span><div class="meter-container" id="meter-L"></div></div>
                        <div class="vu-row"><span class="vu-label on" id="lbl-R">R</span><div class="meter-container" id="meter-R"></div></div>
                    </div>
                </section>

                <div class="numeric-grid">
                    <button class="btn" onclick="handleNumKey(1)">1</button><button class="btn" onclick="handleNumKey(2)">2</button><button class="btn" onclick="handleNumKey(3)">3</button>
                    <button class="btn" onclick="handleNumKey(4)">4</button><button class="btn" onclick="handleNumKey(5)">5</button><button class="btn" onclick="handleNumKey(6)">6</button>
                    <button class="btn" onclick="handleNumKey(7)">7</button><button class="btn" onclick="handleNumKey(8)">8</button><button class="btn" onclick="handleNumKey(9)">9</button>
                    <button class="btn" onclick="handleNumKey(0)">0</button>
                </div>

                <div class="transport-grid">
                    <button class="btn" id="eject-btn">⏏ EJECT</button>
                    <button class="btn" id="prev-btn">|◀◀</button>
                    <button class="btn" id="play-btn">▶ / ||</button>
                    <button class="btn" id="next-btn">▶▶|</button>
                    <button class="btn" id="stop-btn">■</button>
                </div>
            </div>

            <div class="controls-right-stack" style="display: flex; flex-direction: column; gap: 20px;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="btn" id="rew-btn">◀◀</button><button class="btn" id="fwd-btn">▶▶</button>
                    <button class="btn" id="minus-10-btn">-10s</button><button class="btn" id="plus-10-btn">+10s</button>
                    <button class="btn" id="shuffle-btn">Shuffle</button><button class="btn" id="repeat-btn">Repeat</button>
                    <button class="btn" id="ab-btn">A-B</button><button class="btn" id="peak-btn">Peak</button>
                    <button class="btn" id="time-btn">Time</button><button class="btn" id="vu-btn">VU</button>
                </div>
                
                <div style="display: flex; gap: 40px; justify-content: center;">
                    <div class="knob-container">
                        <span style="font-size:10px; font-weight:bold; color:white;">PHONES VOL</span>
                        <div class="knob vol-knob" id="vol-knob"></div>
                    </div>
                    <div class="knob-container">
                        <span style="font-size:10px; font-weight:bold; color:white;">JOG SHUTTLE</span>
                        <div class="knob jog-knob" id="jog-knob"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const audio = new Audio();
        audio.crossOrigin = "anonymous";
        let playlist = [], currentIndex = 0;
        let currentArt = "technics_logo.png", currentMeta = "Technics - Audio Systems - Professional";
        let repeatMode = 0, isShuffle = false, timeMode = 0, isVUOn = true;
        let pointA = null, pointB = null, isPeakSearching = false;
        let inputBuffer = "", inputTimeout = null, volDisplayTimeout = null;
        let audioCtx, analyzer, dataArray;

        const gridWrapper = document.getElementById('grid-numbers-wrapper');
        for(let i=1; i<=20; i++) {
            const s = document.createElement('span'); s.className='grid-num'; s.id=`gn-${i}`; s.innerText=i; gridWrapper.appendChild(s);
        }

        // --- GESTION VOLUME ---
        function showVolumeDisplay() {
            if (volDisplayTimeout) clearTimeout(volDisplayTimeout);
            const timeLabel = document.getElementById('time-label');
            const timeSep = document.getElementById('time-sep');
            timeLabel.innerText = "VOLUME";
            timeSep.style.opacity = "0";
            let volPerc = Math.round(audio.volume * 100);
            const s = volPerc.toString().padStart(2, '0');
            document.getElementById('m-d1').innerText = " ";
            document.getElementById('m-d2').innerText = s.length > 2 ? s[0] : " ";
            document.getElementById('s-d1').innerText = s.length > 2 ? s[1] : s[0];
            document.getElementById('s-d2').innerText = s.length > 2 ? s[2] : s[1];
            volDisplayTimeout = setTimeout(() => {
                volDisplayTimeout = null;
                timeLabel.innerText = "Min : Sec";
                timeSep.style.opacity = "1";
                updateTimeDisplay();
            }, 2000);
        }

        // --- FONCTION PEAK SEARCH ---
        document.getElementById('peak-btn').onclick = async () => {
            if (!playlist.length || isPeakSearching) return;
            isPeakSearching = true;
            audio.pause();
            
            const timeLabel = document.getElementById('time-label');
            const originalLabel = timeLabel.innerText;
            timeLabel.innerText = "PEAK SEARCH";
            document.getElementById('main-time-display').classList.add('vfd-input-blink');

            let maxVal = 0;
            let peakTime = 0;
            const step = audio.duration / 50; // Analyse 50 points du morceau
            
            for(let i=0; i < 50; i++) {
                audio.currentTime = i * step;
                // Petit délai pour laisser l'analyseur capter la donnée
                await new Promise(r => setTimeout(r, 40));
                analyzer.getByteFrequencyData(dataArray);
                let currentMax = Math.max(...dataArray);
                if(currentMax > maxVal) {
                    maxVal = currentMax;
                    peakTime = audio.currentTime;
                }
            }

            // Fin de recherche
            audio.currentTime = peakTime;
            document.getElementById('main-time-display').classList.remove('vfd-input-blink');
            timeLabel.innerText = "PEAK FOUND";
            
            // Simuler l'affichage du peak sur le VU
            const simulatedVal = Math.floor((maxVal / 255) * 40);
            ['meter-L', 'meter-R'].forEach(id => {
                const el = document.getElementById(id);
                for (let i = 0; i < simulatedVal; i++) el.children[i].className = 'meter-segment' + (i > 34 ? ' on-red' : ' on-blue');
            });

            setTimeout(() => {
                timeLabel.innerText = originalLabel;
                isPeakSearching = false;
                updateTimeDisplay();
            }, 2000);
        };

        document.getElementById('vu-btn').onclick = () => {
            isVUOn = !isVUOn;
            const labels = [document.getElementById('lbl-L'), document.getElementById('lbl-R')];
            if (!isVUOn) {
                labels.forEach(l => l.className = 'vu-label');
                ['meter-L', 'meter-R'].forEach(id => {
                    const el = document.getElementById(id);
                    for (let i = 0; i < 40; i++) el.children[i].className = 'meter-segment';
                });
            } else {
                labels.forEach(l => l.className = 'vu-label on');
            }
        };

        document.getElementById('ab-btn').onclick = () => {
            if (playlist.length === 0) return;
            const abVfd = document.getElementById('vfd-ab');
            if (pointA === null) {
                pointA = audio.currentTime;
                abVfd.classList.add('active', 'vfd-input-blink');
            } else if (pointB === null) {
                if (audio.currentTime > pointA) {
                    pointB = audio.currentTime;
                    abVfd.classList.remove('vfd-input-blink');
                    abVfd.classList.add('active');
                    audio.currentTime = pointA;
                }
            } else {
                pointA = null; pointB = null;
                abVfd.classList.remove('active', 'vfd-input-blink');
            }
        };

        document.getElementById('power-reset-btn').onclick = () => {
            audio.pause(); audio.src = ""; audio.volume = 0.02;
            document.getElementById('vol-knob').style.transform = `rotate(-110deg)`;
            playlist = []; currentIndex = 0; pointA = null; pointB = null;
            document.querySelectorAll('.vfd-indicator').forEach(el => el.classList.remove('active', 'vfd-input-blink'));
            updateDig('t', 0); updateGrid();
            document.getElementById('tray-front').classList.add('open');
            showVolumeDisplay();
        };

        document.getElementById('play-btn').onclick = () => {
            if (!playlist.length || isPeakSearching) return;
            audio.paused ? audio.play() : audio.pause();
            document.getElementById('main-time-display').classList.toggle('vfd-blink-dim', audio.paused);
        };

        document.getElementById('stop-btn').onclick = () => { 
            audio.pause(); audio.currentTime = 0; 
            document.getElementById('main-time-display').classList.remove('vfd-blink-dim'); 
            updateTimeDisplay();
        };

        function setupKnob(id, callback) {
            const el = document.getElementById(id);
            let startY, startRot = (id === 'vol-knob' ? -110 : 0);
            let currentRot = startRot;
            el.onmouseenter = () => { if(id === 'vol-knob') showVolumeDisplay(); };
            el.onmousedown = (e) => {
                startY = e.clientY;
                document.onmousemove = (me) => {
                    let diff = (startY - me.clientY);
                    currentRot = startRot + diff;
                    el.style.transform = `rotate(${currentRot}deg)`;
                    callback(diff);
                    if(id === 'vol-knob') showVolumeDisplay();
                };
                document.onmouseup = () => { startRot = currentRot; document.onmousemove = null; };
            };
        }

        setupKnob('vol-knob', (diff) => { audio.volume = Math.max(0, Math.min(1, audio.volume + (diff / 5000))); });
        setupKnob('jog-knob', (diff) => { if(!audio.paused) audio.currentTime += (diff / 100); });

        function updateDig(prefix, val) {
            const s = Math.floor(Math.abs(val)).toString().padStart(2, '0');
            document.getElementById(`${prefix}-d1`).innerText = s[s.length-2] || "0";
            document.getElementById(`${prefix}-d2`).innerText = s[s.length-1] || "0";
        }

        function updateTimeDisplay() {
            if(volDisplayTimeout || isPeakSearching) return; 
            let d = timeMode === 0 ? audio.currentTime : (audio.duration || 0) - audio.currentTime;
            const mins = Math.floor(d / 60).toString().padStart(2, '0');
            const secs = Math.floor(d % 60).toString().padStart(2, '0');
            document.getElementById('m-d1').innerText = mins[mins.length-2] || "0";
            document.getElementById('m-d2').innerText = mins[mins.length-1] || "0";
            document.getElementById('s-d1').innerText = secs[secs.length-2] || "0";
            document.getElementById('s-d2').innerText = secs[secs.length-1] || "0";
        }

        function updateGrid() {
            for(let i=1; i<=20; i++) {
                const el = document.getElementById(`gn-${i}`);
                el.classList.toggle('loaded', i <= playlist.length);
                el.classList.toggle('active-track', i === currentIndex + 1 && playlist.length > 0);
            }
        }

        function loadTrack(idx) {
            if (!playlist.length) return;
            currentIndex = (idx + playlist.length) % playlist.length;
            audio.src = URL.createObjectURL(playlist[currentIndex]);
            updateDig('t', currentIndex + 1);
            updateGrid(); audio.play();
            document.getElementById('main-time-display').classList.remove('vfd-blink-dim'); 
            setupAudio(); extractMetadata(playlist[currentIndex]);
        }

        audio.ontimeupdate = () => {
            if (pointA !== null && pointB !== null && audio.currentTime >= pointB) audio.currentTime = pointA;
            updateTimeDisplay();
        };

        function handleNumKey(num) {
            if (!playlist.length) return;
            clearTimeout(inputTimeout);
            inputBuffer += num;
            document.getElementById('track-vfd-box').classList.add('vfd-input-blink');
            updateDig('t', parseInt(inputBuffer));
            if (inputBuffer.length >= 2) executeJump();
            else inputTimeout = setTimeout(() => { executeJump(); }, 2000);
        }

        function executeJump() {
            document.getElementById('track-vfd-box').classList.remove('vfd-input-blink');
            let trackNum = parseInt(inputBuffer);
            if (!isNaN(trackNum) && trackNum > 0 && trackNum <= playlist.length) loadTrack(trackNum - 1);
            else updateDig('t', currentIndex + 1);
            inputBuffer = "";
        }

        function extractMetadata(file) {
            jsmediatags.read(file, {
                onSuccess: (tag) => {
                    const t = tag.tags;
                    currentMeta = `${t.artist || "Unknown Artist"} - ${t.album || "Unknown Album"} - ${t.title || file.name}`;
                    const p = t.picture;
                    if (p) {
                        let b64 = ""; for(let i=0; i<p.data.length; i++) b64 += String.fromCharCode(p.data[i]);
                        currentArt = `data:${p.format};base64,${window.btoa(b64)}`;
                    } else { currentArt = "technics_logo.png"; }
                }
            });
        }

        document.getElementById('file-input').onchange = (e) => { 
            playlist = Array.from(e.target.files); 
            if(playlist.length) { document.getElementById('tray-front').classList.remove('open'); loadTrack(0); }
        };

        document.getElementById('next-btn').onclick = () => loadTrack(currentIndex + 1);
        document.getElementById('prev-btn').onclick = () => loadTrack(currentIndex - 1);
        document.getElementById('eject-btn').onclick = () => document.getElementById('tray-front').classList.toggle('open');
        document.getElementById('shuffle-btn').onclick = () => { isShuffle = !isShuffle; document.getElementById('vfd-shuffle').classList.toggle('active', isShuffle); };
        document.getElementById('repeat-btn').onclick = () => { 
            repeatMode = (repeatMode + 1) % 3;
            document.getElementById('vfd-repeat-1').classList.toggle('active', repeatMode === 1);
            document.getElementById('vfd-repeat-all').classList.toggle('active', repeatMode === 2);
        };
        document.getElementById('time-btn').onclick = () => { timeMode = (timeMode + 1) % 2; };
        
        function openArt() { 
            document.getElementById('art-image').src = currentArt; 
            document.getElementById('art-info').innerText = currentMeta;
            document.getElementById('art-modal').style.display = 'flex'; 
        }

        function setupAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const src = audioCtx.createMediaElementSource(audio);
            analyzer = audioCtx.createAnalyser(); analyzer.fftSize = 64;
            src.connect(analyzer); analyzer.connect(audioCtx.destination);
            dataArray = new Uint8Array(analyzer.frequencyBinCount);
            renderVU();
        }

        function renderVU() {
            requestAnimationFrame(renderVU);
            if (!analyzer || !isVUOn || isPeakSearching) return;
            analyzer.getByteFrequencyData(dataArray);
            ['meter-L', 'meter-R'].forEach((id, idx) => {
                const el = document.getElementById(id);
                const val = Math.floor((dataArray[idx + 2] / 255) * 40);
                for (let i = 0; i < 40; i++) {
                    el.children[i].className = 'meter-segment' + (i < val ? (i > 34 ? ' on-red' : ' on-blue') : '');
                }
            });
        }

        ['meter-L', 'meter-R'].forEach(id => {
            const el = document.getElementById(id);
            for(let i=0; i<40; i++) el.appendChild(document.createElement('div')).className = 'meter-segment';
        });

        audio.volume = 0.02;
    </script>
</body>
</html>
